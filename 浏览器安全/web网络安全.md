# web网络安全

## 存在原因：
- HTTP「明文传输」。只要中间环节例如：用户电脑，wifi路由器，运营商，目标服务器被人窃取或篡改，都可能拿到或者修改数据。

## 加密方案 - TCL和HTTP之间插入一个安全层
- 主要工作：将HTTP的请求的数据进行加密，接收到的HTTP内容进行解密。
![](https://static001.geekbang.org/resource/image/9e/cf/9e99f797de30a15a11b0e4b4c8f810cf.png)

## 升级过程：

### 对称加密 - 加解密都是用相同的密钥
![](https://static001.geekbang.org/resource/image/d8/3b/d86648267d5504c7813b2d692620503b.png)
- 最后通过client random + server random 生成一个master secret。进行加密传输。

- 问题：密钥和加密套件都是明文传输，黑客也能获得来伪造master secret。

### 非对称加密 - 公私钥进行加解密
- 服务器发送公钥给浏览器，自己保存「私钥」。
![](https://static001.geekbang.org/resource/image/b2/50/b2b893921491c62b29aaddc1d4fa9550.png)
- 这样，黑客就拿取不到「浏览器发送的数据」。

- 问题：
  - 非对称加密「效率低」。
  - 无法保证「服务器发送给浏览器」的数据安全。黑客也可以用公钥对数据进行加密。

### 对称和非对称搭配使用
- 传输过程中依然使用对称加密，「传输对称加密的密钥」时使用非对称。
![](https://static001.geekbang.org/resource/image/d5/45/d5cd34dbf3636ebc0e809aa424c53845.png)
- 在服务器发送了公钥后，「浏览器」拿到了client random, server random, 还会生成一个随机数「pre master」，然后用公钥进行加密，发送给服务器。这时，黑客没有私钥是解不出「pre master」的。
- 然后服务器用私钥解密拿到「pre master」后，两端都会有client random, server random, pre master，然后会用其生成「对称密钥」。在最后也是通过该密钥传输。

- 问题：如果黑客通过DNS挟持到服务器的IP地址，换成了黑客服务器的地址，就可以用黑客服务器的公私钥进行传输。

### 数字证书
- 加入数字证书的TLS加密。
![](https://static001.geekbang.org/resource/image/77/af/77c852ff2202b2b7bb3299a96a0f4aaf.png)
- 添加了数字证书后，服务器没有直接返公钥给浏览器，而是包含在数字证书中。所以，浏览器多了一个「验证证书的操作」。
- 引入数字证书，实现了服务器的身份认证功能，就算黑客伪造了服务器，也没办法伪造证书。
- 对于浏览器来说，CA有两个作用：
  - 通过数字证书证明服务器身份。
  - 数字证书里拿到服务器的公钥。

#### 数字证书申请：
![](https://static001.geekbang.org/resource/image/f5/a6/f569c80f8f4b25b3bf384037813cdca6.png)
  - 服务器准备好一份公私钥。「私钥」会留着自己使用。
  - 提交给CA机构公钥，公司，站点等相关信息。
  - CA通过各种渠道验证信息的真实性，域名归属。
  - 审核过后，会签发数字证书，包含了：「域名的公钥」，「CA信息」，组织信息，有效时间，「证书序列号」，「CA生成的签名」。同时这些信息都是「明文」的。

#### CA生成的签名：
  - 首先CA使用hash计算提交中的明文信息，得到「信息摘要」。
  - 然后用「CA自己的私钥」加密「信息摘要」，即是「数字签名」。

#### 浏览器如何验证书字证书
- 浏览器会将得到的CA证书中的明文信息，使用和CA机构相同的hash计算方式进行计算。得到「摘要A」。
- 再用「CA公钥」解密数字签名，得到「摘要B」。
- 如果一致，并且「相关域名，有效时间」验证没问题后，而且，「CA是真实的CA机构」，则说明「数字证书合法」。

#### 如何验证CA机构是否合法
- 如果不认识这个CA，会继续查找数字证书链，找到上一个认证该CA的CA。
- 操作系统内会内置信任顶级CA的证书信息，根证书经过WebTrust认证，包括「公钥」。

#### 需要注意的点
- 服务器永远只掌控「服务器私钥」。
- 数字证书最核心是用CA的私钥生成数字签名。
- 内置CA是CA的根证书，「自己为自己签名」，称为自签名证书。

#### 浏览器如何获得CA公钥
- 服务器在「申请数字证书」过程中，会拿到「CA的公钥和一些其他基础信息」。包括：
  - 极客时间域名的数字证书，用于TLS中的证书。
  - 给极客时间签名的「CA机构的数字证书」。
#### 怎么拿到
- 在建立HTTPS链接时，服务器会将「两个证书一起发送给浏览器」，这样，浏览器就可以拿到CA的公钥拉。
- 如果服务器没有部署CA证书，浏览器也可以通过「网络去下载证书」。

- 数字证书问题： 如果拿到了系统权限，安装别的根证书，HTTPS也会变得不安全。

## 证书伪造：Expect-CT
- 原因：
  - CA签发了一些错误的证书，没有校验申请者的身份。
  - 攻击者会伪造成某个域名的拥有者，申请到一张证书。
- 防御：让网站知晓域名对应证书签发的全过程。一旦发现攻击者伪造，立即吊销证书。
  - Expect-CT：让浏览器期望使用证书透明度服务。



