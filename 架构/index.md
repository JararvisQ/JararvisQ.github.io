# 前端架构

## 为什么
- 解决已存在或未来可能发生的技术问题，增加项目的可管理性，稳定性，可扩展性。

## 准则
- 人效比：对于需要额外开发工作量的事务，需要考虑两个因素：花费的人力成本；未来可能节约的时间和金钱。
- 定性和定量：架构里涉及到的设计，一定是有可衡量意义的，最好是可以用数据（埋点系统）来表达带来的收益和减少的成本。

## 设计

### 基础层
- `代码托管`：GitLab，提供代码管理、权限管理、提交日志等功能。

- `版本管理`
  - 发布后分支锁死。例如：指当例如0.0.1版本成功发布后，不可再更改0.0.1分支上的代码；
  - 全自动流程发布：发布后自动发布到预发布/生产环境，避免开发人员直接操作相关环境。
  - 多版本并存。例如发布0.0.2版本后，0.0.1版本的代码应仍保存在线上（例如CDN）。当出现BUG后，方便快速回滚到上一个版本。

- `自动编译发布`
  - 代码发布后，自动执行相关操作，例如：自动编译打包，再从GitLab发布到CDN或者静态服务器。可以让开发和环境和运维脱钩。

- `纯前端版本发布`
  - 前端代码发布到生产环境。可以通过`外网连接+正确的版本号`访问到新版本的代码，但页面上的资源还是旧版本。
  - 通过配置工具，直接更新HTML文件，将引入的资源改为新版本。

  - ### 怎么做
    - 配置长时间的本地缓存
    - 以内容作为缓存标识的更新依据（文件名）
    - 静态资源通过CDN部署
    - 非覆盖式发布

- `统一脚手架`
  - 统一项目结构、技术栈，减少开发人员配置构建时的重复时间损耗

- `Node中间层`
  - 解决SEO，React，Vue同构，前端读取后端服务 / 数据库。质变地提高前端的开发效率和对业务的支撑能力，可能导致P0级故障。

- ### `埋点系统`
  - 怎么做：
    - 记录每个页面的访问量（PV，UV）
    - 每个功能的使用量
    - 捕捉报错信息
    - 图表化展示
  
  - 为什么：
    - 不同于后端的日志系统，用户侧可以把握用户习惯，给到业务；技术侧，可以针对性地优化功能，页面，布局，用户使用流程。

- `监控和报警系统` - 基于埋点系统而建立
  - 当访问量有较大地变化时（比如日PV/UV只有之前20%以下），自动触发警报，发送邮件到相关人员邮箱。
  - 报错量大幅度上升（比如200%或更高），则触发报警；
  - 每过一段时间，自动汇总访问者/报错触发者的相关信息（例如系统、浏览器版本等）

  - ### 为什么：
    - 能提前发现不容易发现的bug，虽然不会导致资损，但很容易影响到某个链路的正常使用。

- 安全管理
  - 通常要依赖后端。但也有一定的解决方案。
    - XSS注入：用户输入内容转码。禁止使用`eval`函数
    - HTTPS
    - CSRF：server端至少在关键页面上加入CSRF处理方法。

- Eslint
  - 提前预知风险，降低低级bug，提高代码可维护性。
  - 统一团队代码风格。

  - ### 建议：
    - 配置到脚手架上，并且在发布时执行eslint检查。

- 灰度发布
  - ### 是什么：
    - 发布版本时，初始情况下，只允许小比例（比如1~5%比例的用户使用），若出现问题时，可以快速回滚使用老版本，适用于主链路和访问量极大的页面。

  - 控制风险。可以在生产环境小范围尝试新版本是否可以运行。
  - 配合埋点和警报查看效果和用户反馈，对于大版本更新，可以灰度一部分。
  - 需要验证某些想法和问题时，灰度一部分，快速验证效果。

  - 操作：
    - 要多个阶段：1% - 5% - ... - 100%
    - 允许配置某些IP/账号访问，可以直接访问到灰度版本

- 前后端分离 - 指的是分配前后端掌控的领域
  - 中小项目时，一般后端负责通过url指向某个HTML，前端负责HTML,CSS,JS。但大型项目，建议前端负责html以外的静态资源，「html交给后端」。

  - ### 为什么
    - 后端渲染，方便统一插入一些代码和资源，例如：埋点JS，监控JS，国际化文本资源，页面标识，通常由后端调用某些服务直接写入。
    - 当页面需要统一头尾时，header，footer。
    - 如果有些东西（facebook初始化），通过HTML来管理，耦合度太高，违背解耦和分离原则。
    - 可以从单独的页面控制发布的内容，更有利于灰度发布。
    - 更有利于页面管理，减低页面和功能的耦合度，减少复杂页面的环境配置时间。

- Mock
  - ### 是什么：后端接口未好时，生成返回的数据，更好前后端并行开发，减低沟通成本
  - ### 怎么做：不建议开发个专门的系统，更好的是嵌入到脚手架中。
    - 开发环境下?debug=true，读取到后不访问接口，直接异步访问到XXX.json
    - 线上接口能拿到数据后，存入xxx.json中

- 定期备份
  - 服务器损坏，该服务器上的东西都没了
  - 致命bug
  
  - 常见方法：定期备份，多机备份

### 应用层
- 多页和单页 - 通常推荐采用多页面的架构，降低长期项目迭代的难度。
  - 多页项目，每个页面之间都是独立的，当一个页面需要重构时，不会影响其他页面，可以单次只更新一个页面，如果是单页，很容易让所有的页面都需要进行更新。
  - 多页缺点是：不同页面切换时，会有一个白屏时间，但通常时间并不长。
  - 多页项目的版本控制更明确。
  - 灰度发布更友好。

- 以应用为单位划分前端项目 - 不同的应用放在不同仓库

  - 问题：
    - 极大增加代码的维护难度
    - 项目结构丑陋
    - 不方便权限管理，容易造成代码更改或者代码泄露
    - 任何人都有权利更改任何界面，代码合并时，review困难。

  - ### 为什么？
    - 方便进行管理，可以只给到该业务前端的开发权限
    - 发布应用时，只需要发布所属的应用即可。

- 基础组件库
  - 建议团队多人时建设，需要人维护。要求统一技术栈，为了最大化基础组件库的效益。

  - 建议
    - 使用TS
    - 可扩展性强
    - 使用程度高
    - 文档清楚
    - 版本隔离，小版本优化加功能，大改需要发大版本更新
    - 和UI协作统一，需要UI参与进来

- 技术栈统一
  - 所有团队尽量共用，方便招人，简化培养成本。

- 浏览器兼容 - 常见的IE6，7，8，小众浏览器PC手机的奇怪问题，考虑统一的解决方案

  - 配置postcss，添加css兼容性前缀
  - loader 处理某些特殊场景
  - 规范团队代码，使用更稳定的写法
  - 引导采用高版本的浏览器

- 内容平台建设 - 内部论坛，博客

  - 记录技术发展历史
  - 研发同学经验分享
  - 文章推荐
  - 内部交流
  - 某些技术问题可以进行讨论

- 权限管理平台 - 管理和规范同学的可访问内容范围

  - 必须要和服务端结合，需要有专门的控制模块负责处理权限问题（后端处理。或者前端通过中间层例如Node层介入处理）
  - 自动化流程控制，并流程具体明确，创建，申请，审批，离职，必要时可以触发警报
  - 权限有失效性，减少永久性权限
  - 高可修改性，方便公司后期流程优化

- 登录系统设计 - 单点登录

  - 用户在一处登录时，可以在任何页面访问；登出时，也会在任何页面失去登录状态
  
  - ### 为什么
    - 增强用户体验
    - 打通不同业务系统之间的用户数据
    - 方便管理用户

- CDN
  - 提高前端资源加载速度，请求资源时访问比较近的CDN服务器，减少时延
  - 降低服务器带宽使用成本
  - 减低DDOS攻击的影响

- 负载均衡

  - Nginx，在大型项目中和分布式几乎是必须的。

  - 减低单台server的压力
  - 方便应对峰值流量，扩容方便（活动时）

- 多端公用一套接口
  - 不同场景一个业务，但套用了不同的接口，除非特殊需求，不然建议公用一套系统。

  - 