# 前端架构

## 为什么
- 解决已存在或未来可能发生的技术问题，增加项目的可管理性，稳定性，可扩展性。

## 准则
- 人效比：对于需要额外开发工作量的事务，需要考虑两个因素：花费的人力成本；未来可能节约的时间和金钱。
- 定性和定量：架构里涉及到的设计，一定是有可衡量意义的，最好是可以用数据（埋点系统）来表达带来的收益和减少的成本。

## 设计

### 基础层
- `代码托管`：GitLab，提供代码管理、权限管理、提交日志等功能。

- `版本管理`
  - 发布后分支锁死。例如：指当例如0.0.1版本成功发布后，不可再更改0.0.1分支上的代码；
  - 全自动流程发布：发布后自动发布到预发布/生产环境，避免开发人员直接操作相关环境。
  - 多版本并存。例如发布0.0.2版本后，0.0.1版本的代码应仍保存在线上（例如CDN）。当出现BUG后，方便快速回滚到上一个版本。

- `自动编译发布`
  - 代码发布后，自动执行相关操作，例如：自动编译打包，再从GitLab发布到CDN或者静态服务器。可以让开发和环境和运维脱钩。

- `纯前端版本发布`
  - 前端代码发布到生产环境。可以通过`外网连接+正确的版本号`访问到新版本的代码，但页面上的资源还是旧版本。
  - 通过配置工具，直接更新HTML文件，将引入的资源改为新版本。

  - ### 怎么做
    - 配置长时间的本地缓存
    - 以内容作为缓存标识的更新依据（文件名）
    - 静态资源通过CDN部署
    - 非覆盖式发布

- `统一脚手架`
  - 统一项目结构、技术栈，减少开发人员配置构建时的重复时间损耗

- `Node中间层`
  - 解决SEO，React，Vue同构，前端读取后端服务 / 数据库。质变地提高前端的开发效率和对业务的支撑能力，可能导致P0级故障。

- ### `埋点系统`
  - 怎么做：
    - 记录每个页面的访问量（PV，UV）
    - 每个功能的使用量
    - 捕捉报错信息
    - 图表化展示
  
  - 为什么：
    - 不同于后端的日志系统，用户侧可以把握用户习惯，给到业务；技术侧，可以针对性地优化功能，页面，布局，用户使用流程。

- `监控和报警系统` - 基于埋点系统而建立
  - 当访问量有较大地变化时（比如日PV/UV只有之前20%以下），自动触发警报，发送邮件到相关人员邮箱。
  - 报错量大幅度上升（比如200%或更高），则触发报警；
  - 每过一段时间，自动汇总访问者/报错触发者的相关信息（例如系统、浏览器版本等）

  - ### 为什么：
    - 能提前发现不容易发现的bug，虽然不会导致资损，但很容易影响到某个链路的正常使用。

- 安全管理
  - 通常要依赖后端。但也有一定的解决方案。
    - XSS注入：用户输入内容转码。禁止使用`eval`函数
    - HTTPS
    - CSRF：server端至少在关键页面上加入CSRF处理方法。

- Eslint
  - 提前预知风险，降低低级bug，提高代码可维护性。
  - 统一团队代码风格。

  - ### 建议：
    - 配置到脚手架上，并且在发布时执行eslint检查。

- 灰度发布
  - ### 是什么：
    - 发布版本时，初始情况下，只允许小比例（比如1~5%比例的用户使用），若出现问题时，可以快速回滚使用老版本，适用于主链路和访问量极大的页面。

  - 控制风险。可以在生产环境小范围尝试新版本是否可以运行。
  - 配合埋点和警报查看效果和用户反馈，对于大版本更新，可以灰度一部分。
  - 需要验证某些想法和问题时，灰度一部分，快速验证效果。

  - 操作：
    - 要多个阶段：1% - 5% - ... - 100%
    - 允许配置某些IP/账号访问，可以直接访问到灰度版本

- 前后端分离 - 指的是分配前后端掌控的领域
  - 中小项目时，一般后端负责通过url指向某个HTML，前端负责HTML,CSS,JS。但大型项目，建议前端负责html以外的静态资源，「html交给后端」。

  - ### 为什么
    - 后端渲染，方便统一插入一些代码和资源，例如：埋点JS，监控JS，国际化文本资源，页面标识，通常由后端调用某些服务直接写入。
    - 当页面需要统一头尾时，header，footer。
    - 如果有些东西（facebook初始化），通过HTML来管理，耦合度太高，违背解耦和分离原则。
    - 可以从单独的页面控制发布的内容，更有利于灰度发布。
    - 更有利于页面管理，减低页面和功能的耦合度，减少复杂页面的环境配置时间。

- Mock
  - ### 是什么：后端接口未好时，生成返回的数据，更好前后端并行开发，减低沟通成本
  - ### 怎么做：不建议开发个专门的系统，更好的是嵌入到脚手架中。
    - 开发环境下?debug=true，读取到后不访问接口，直接异步访问到XXX.json
    - 线上接口能拿到数据后，存入xxx.json中

- 定期备份
  - 服务器损坏，该服务器上的东西都没了
  - 致命bug
  
  - 常见方法：定期备份，多机备份
