# 缓存策略
## ![](/image/流程图.png)

- 浏览器每次发起请求，都会在浏览器缓存中查找是否有对应缓存以及缓存标识。

- 每次拿到请求结果都会将该结果和请求标识存入浏览器缓存。

## 强制缓存
- 向浏览器缓存查找请求结果，如果有缓存则判定缓存标识，符合就直接用缓存。
- 不存在则直接向浏览器发送请求。
- 存在，但失效了。强缓存失效，使用协商缓存。

- 控制字段：Expires和Cache-Control，其中Cache-Control优先比Expires高
  - expires。请求结果的过期时间。如果客户端时间小于expires，直接使用缓存结果。
  - cache-control。由于客户端和服务端时间不同步，很容易导致缓存失效。
    - private。只有客户端可以缓存。默认取值
    - public。所有内容都将被缓存（客户端和代理服务器都可缓存）。
    - no-cache。客户端缓存内容，是否使用缓存需要「协商缓存」决定。
    - no-store。不被缓存。
    - max-age。缓存内容将在XXX秒后失效。

## 协商缓存
- 强缓存失效后，浏览器通过带上「缓存标识」，由服务器决定是否使用缓存的情况。（返回304协商缓存成功）
- 相关字段。
  - Last-Modified / If-Modified-Since。服务器最后修改的时间。
  - Etag / If-None-Match。服务器根据修改时间生成的一个唯一标识，
  - 其中Etag / If-None-Match的优先级比Last-Modified / If-Modified-Since高。

## 三级缓存
- memory cache。内存缓存。刷新Tab时命中有效，随进程关闭则清除。
- disk cache。硬盘缓存。读取时需要IO操作，
- 以上都是缓存请求返回的结果和缓存标识。

## 总结

![](/image/缓存策略.png)

- 强缓存优先于协商缓存。
- 强缓存生效时立即使用。不生效走协商缓存。
- 协商缓存中，服务器返回304，缓存命中。200则缓存失效，并将结果存入浏览器缓存。
- 对于频繁变动的资源采用协商缓存的形式，使每次都请求服务器确认；对于不常变化的资源，设置标识 - 强缓存（当变化时名字加上hash）。