# JS如何阻塞DOM解析

## 什么是DOM
- DOM是生成页面的基本数据结构，并赋予JS操作文档的接口，又是抵御不安全内容的防线。

## DOM树如何生成
- 当网络进程通过content-type判定收到的内容是一个HTML文件时，会为该请求选择或者创建一个渲染进程。
- 渲染进程准备好后，会在网络进程和渲染进程之间创建一个管道。收取网络进程传过来的字节流数据。
![](https://static001.geekbang.org/resource/image/1b/8c/1bfcd419acf6402c20ffc1a5b1909d8c.png)
- 收到的字节流数据，HTML解析器通过分词器，生成Node。通过维护一个「token栈」，生成一棵DOM树。
- 同时，渲染引擎还有一个「XSSAuditor」安全检查模块。分词器解析出来token后，会检查模块是否安全，是否符合CSP规范，是否跨站点请求。

## JS如何影响DOM生成
- 如果遇到了```<script>```脚本，此时HTML解析器会暂停DOM解析，因为JS里可能会修改生成的DOM的结构。
- 如果遇到「引入」的JS脚本，会先暂停DOM解析，先下载这段JS代码，在执行JS代码，再解析DOM。

### 预解析
- 当渲染引擎收到字节流后，会开启一个预解析「线程」（不阻塞）。用来分析HTML文件中的JS，css相关文件，会提前下载这些文件。

- 由于JS可能会修改css的内容，所以执行js的时候，还需要等外部的css下载，解析成CSSOM对象后才执行JS。

## async defer

## 总结
- css和JS都阻塞到DOM的解析，同时CSS又会阻塞JS的执行。