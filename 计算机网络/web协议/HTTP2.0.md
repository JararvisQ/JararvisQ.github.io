# 流行的原因：
- 没有改变原来HTTP1.1的架构。
- http1.1可以通过「代理方式」转接到HTTP2，不识别HTTP2的链接也能请求降级到http1。

# 主要特性：
- 传输的数据量大幅减少。
  - 二进制方式传输
  - header头部压缩
- 多路复用
  - 消息优先级
- 服务端消息推送
  - 并行推送

# 帧frame，消息message，流stream
- 链接 > stream > message > frame
- 帧里有一个steamID和steam对应起来。「steam < - > frame」
- 传输时无序，接受时按steamID进行组装。

## 介绍
- 一个TCP链接：包含一个或者多个stream
- stream：一个双向通讯数据流，包含1条或者多条message
- message：对应于http1中的请求或者响应，包含一条或多条frame。 - 业务上的概念，报文里没有关于消息的标识
- frame：最小单位，二进制压缩存放http1的内容

# SteamID - 多路复用 - 流控
1. 接收端的实现按steamID进行并发组装消息。
2. 「多路复用基于多个steam，`同frame`内必须是有序的。所以针对于frame内部，数据还是串行的数据传输。」
3. 客户端建立的steam流必须是奇数，服务端建立的steam是偶数的。 「推送依赖性请求的关键」
4. steamID必须递增，不可复用，状态未「idle」为closed状态；如果ID用完后必须建立新链接。
5. steamID为0的仅用于传输控制帧。

# 头部压缩
通用映射表进行映射，之后修改找出不同的地方进行修改

## HPACK算法 - 减少http无状态的副作用
- 将HTTP头部的通用header在映射表进行映射。
- 在第二次开始，对上一次的header的表头找出不同的地方，进行修改。「压缩比越来越高」

## 同一地址空间下的静态表和动态表
- 静态表：61项
- 动态表：先入先出的策略。
- 同时根据第1+次进行编码。

## huffman编码 - header的字母key：value
- 出现概率较大的符号采用较短的编码，概率较小的符号采用较长的编码。
- 树的构造：
  - 计算个各字母的出现概率。
  - 出现频率最小的两个字母构成子树。左小右大。
  - 从左到右，左0右1进行编码。

# 服务器推送
- 基于已经发送的请求，例如客户端的HTML，主动推送js文件。
- 在不同steam进行发送，因为同一steam的同一帧内，不可并发，只能新建一个steam。
- 实现方式：
  - 推送资源必须对应一个请求。
  - 通过`push_promise帧`指定发送steamID指定资源进行推送。
  - 响应在偶数ID的steam中发送。


# steam优先级

## steam流的状态
- 由idle开始到closed结束。
## stream特性
- 一条TCP链接中可以存在多条open状态的steam。
- 同一条steam内的帧是有序的。
- 从steamID可以分辨出是push消息。（偶数）

## message特性
- 一条http message由一个header以及0个或者多个data帧构成。
## rst_steam - 可以用来终止一个未完成的流
- 当想终结一个steam时可能会影响别的frame。

## 设置优先级
- priority 优先级设置帧。
- 规则：由依赖关系进行分配优先级。

# HTTP2的流量控制
## 问题:
- 多路复用意味着多个steam必须共享TCP层的流量控制。在「多stream下」，会争夺TCP流的控制，互相干扰可能造成stream阻塞。
- 代理服务器内存有限，上下游网速不一致时，通过流控管理内存。

## 流控 - window_update帧
- 客户端和服务端都有流量控制能力，并且是单向的，各自享有独立的流量控制。
- 一端设置了上限，另一端必须遵循。
- 只有data帧受流量控制，header不受。
- 不能被禁用，且仅针对建立TCP链接的两端，不包括代理服务器。
- 控制open，half-close下的并发数量，不包含推送。

# HTTP2的问题
- TCP链接过多RTT。HTTP2还需要进行TLS握手。
- 必须保证资源的「有序到达」。当丢包率高时，一个流里的帧如果出现丢失，需要等待重发，在定时器结束后才进行重发。

