# 静态资源组织

## 缓存
- index.html会经常更新，而静态资源稳定，所以：`index.html` 适合走协商缓存，相对稳定 & 不常更新的静态资源`（JS、CSS、IMAGES）` 使用强缓存。

### 协商缓存
- 询问服务端，根据一些`request header`来判断是否命中缓存，如果命中返回`304` `Response Header`.
- 字段：`Last-modified, ETag`

- PS：适用于`经常变化`的资源，例如：html。

### 强缓存
- 没有过期，直接读取文件，不会走服务器。
```
Status Code: 200 (From DiskCache)
Status Code: 200 (From MemoryCache)

// 字段
Cache-Control: max-age、Expires
```
- PS：适用`不经常变化`的资源，例如: images

### 强缓存更新的问题 - name hash
- 如果静态资源想修改，但设置的强缓存没过期，怎么修改？
- 通过`content hash`更新资源。

## 覆盖式发布的问题 - 非覆盖式发布
- 问题：页面和静态资源在部署时访问时出现的资源不匹配问题。
- 网站静态文件只有一份，部署在`Nginx`的某个服务器。如果：
  - `先部署静态资源，部署期间访问`时，v1-html 会访问到v2版本的新静态资源，并按v1-hash缓存。如果用户本地有v1缓存，则能正常访问。没缓存则报错。
  - `先部署HTML，部署期间访问`时，v2-html会访问到v1的旧静态资源，按v2-hash缓存。一直找不到资源，持续报错。

- HC：服务器会出现多份`xx.[hash].css`文件。

## web服务器结合CDN
- 问题：
  - 多次部署时，文件逐渐增多，硬盘利用率低；
  - 文件在nignx web服务器下，深度将nginx，网站，部署耦合一起，无法适用CDN。
- 方案: 将静态资源部署到 CDN 上，再将 Nginx 上的流量转发到 CDN 上，这种技术我们称之为『反向代理』。
  - 构建时依据环境变量，HTML静态资源地址加上CDN域名。
    ```js
    module.exports = {
      output: {
        filename: 'bundle.[name].[contenthash:8].js',
        publicPath: `CDN_HOST/CDN_PATH/ENV`
      }
    }
    ```
  - 构建完成后，将静态资源上传到CDN。
    - 上传CDN一般通过客户端上传，需要配置鉴权密码，但不能写在代码里。
  - 并配置Nginx，将静态资源流量转到CDN。(proxy_pass)
    ```nginx
    location ^~/static/ {
      proxy_pass $cdn;
    }
    ```
![](/image/948c9e09d0f32f0354842cab0cf7b5c.png)

# 自动化构建
- 步骤：
  - 拉取远程代码（切换到远程分支）
  - 代码安全检查，单元测试等
  - 安装 npm 依赖（设置node版本，npm源）
  - 编译，构建
  - 产物检查（JS，图片大小，是否安全）
  - 人工卡点（leader审核）
  - 打包上传CDN
  - 自动化测试（e2e）
  - 通知构建完成
## 可能出现的问题：
  - 什么环境下执行构建，保证每次构建部署环境一致？ - `Docker`
  - 如何管理前面提到的CDN密钥？（不增加成本、保证安全、保证构建上传可靠性）
  - 由谁触发构建？如何自动化触发构建 & 自动化执行上述步骤？ - `CI(Jenkins)` + 自动化构建触发 `webhook`
  - 如何提升构建效率？ - webpack [](/打包器/webpack/webpack构建速度，体积优化.md)
  - 如何通知构建已完成？ - 账号体系

# 发布服务

## 静态资源加工
- 解决：为了解决一些部署问题或者提升性能。例如：为了提升首屏性能，新增一层BFF层输入HTML。也可以加入`userInfo、用户权限信息、灰度信息`。
  - 主要流程：
    - 为前端构建出HTML，包含模板变量。
    - 通过proxy将cookie转化为用户信息
    - 在依据版本配置从CDN加载index.html
    - 使用模板引擎等方式将模板变量替换为用户信息
  ![](/image/3db3b64858a963719905cf42126aa6f.png)

## 预发布环境，灰度上线常见实现
- 目的：让特定用户访问特定静态资源版本，从而达到访问Pre/灰度上线的能力。
- 实现：
  - ### Nginx 层动态转发。
    - 请求头携带特定header，Nginx消费该header并转发到对应静态资源。
    ![](/image/4e7504374f8c23903ab32315f12595c.png)
    ```nginx
    location /example {
      rewrite ^ $cdn/$http_x_xx_env/index.html break;
      proxy_pass $cdn/prod/index.html;
    }
    ```
    - 同理：也能实现一些根据UA或者IP的处理，实现灰度上线。
    - 缺点：每个用户都需要手动配置，不适应于移动端，无法获取精确的某个版本。仅适用于工程师。
  - ### 动态配置 + 服务端转发
    - 引入配置中心概念。独立的平台 / SDK，提供动态配置管理的解决方案，提供功能有配置管理、版本管理、权限管理、灰度发布。
    - 流程：主要在读取cookie信息后，读取配置中心数据，依据用户信息判断给用户访问什么环境，加载具体环境 index.html。
    ![](/image/89b2daface4f495843cf2a89660a5ab.png)
    - 缺陷：
      - 和服务端强绑定。
      - 每次都需要从CDN加载HTML，如果缓存HTML，发版还得通知服务端。
      - 若CDN故障，服务端做CDN降级会增加复杂度。

## 版本管理 - 版本回滚

# 前端部署 & 静态资源加工原则
1. 构建发布后，不应该被覆盖。
2. 构建发布后，静态资源应当永久保存在服务器/CDN 上，即只可读。
3. 静态资源组织上，每个版本应该按文件夹存储，做到资源收敛。这样假如真要删除时，可按版本删除。（如某个版本代码泄密）
4. 发布过程应该自动化，开发人员不应该直接接触服务器。
5. 版本切换时，也应当不接触服务器。
6. 版本切换能秒级生效。（如 v0.2 切换 v0.3，立即生效）。
7. 线上需要能同时生效多个版本，满足 AB 测试、灰度、PRE 环境等小流量需求。

# 相关问题

### 1. 前端代码从模板引擎到部署上线，中间会经过哪些流程？分别有哪些考虑，指标，优化点？（满足复杂的业务需求）
- 经历本地开发，远程构建打包部署，安全检测，上传CDN，Nginx做流量转发，静态资源加工。

### 2. 前端静态资源应该如何组织？
  - 强缓存/协商缓存，那前端各种产物（HTML、JS、CSS、IMAGES 等）应该用什么缓存策略？以及为什么？
  - 若使用协商缓存，但静态资源却不频繁更新，如何避免协商过程的请求浪费？
  - 若使用强缓存，那静态资源如何更新？
  - 自动化构建 & 部署过程如何与 CDN 结合？
  - 如何避免前端上线，影响未刷新页面的用户？
  - 如何实现一套前端代码，发布成多套环境产物？
- HTML使用协商缓存，静态资源用强缓存，并使用hash值命名区分做非覆盖式发布。
- 搭配`webpack htmlWebpackPlugin`配置`output public`，并将产物输出到CDN。
- 使用环境变量，将当前环境、CDN、CDN_HOST、Version等注入环境变量中，构建时消费 & 将产物上传不同的CDN即可。

### 3. 刚上线的版本发现有阻塞性 bug，如何做到秒级回滚，而非再次部署等 20 分钟甚至更久？
- HTML文件非覆盖式发布，并如果有发布服务，对HTML进行缓存加工处理，当需要回滚时，直接切换HTML即可。
- 在发布服务中，增加CDN域名替换，异常后在发布服务执行CDN域名替换一件设置。

### 4. 如何实现一个预发环境，除了前端资源外都是线上环境，将变量控制前端环境内？
- 对静态资源做加工，对HTML入口做小流量。
### 5. 部署环节如何方便配套做 AB 测试等？
- [发布服务。](#发布服务)
- 如何实现一套前端代码，发布成多套环境产物？
- 如何实现按 feature 发布产物供用户使用，并逐步扩大 feature 灰度，将影响减到最小（即线上同时存在多 feature 产物）？
### 4. CDN 域名突然挂了，如何实现秒级 CDN 降级修补而非再次全部业务重新部署一次？





